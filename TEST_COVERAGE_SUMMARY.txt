================================================================================
                    MAILMAP TEST COVERAGE ANALYSIS SUMMARY
================================================================================

Project:     Email classification system using local LLM via MCP
Date:        December 12, 2025
Directory:   /home/john/src/mailmap
Status:      65 passing tests, 1 failing test (98.5% pass rate)

================================================================================
                              OVERALL METRICS
================================================================================

Total Code Coverage:              36% (724 lines untested / 1128 total)
Total Tests:                      66 test functions
Test Framework:                   pytest + pytest-asyncio
Lines of Test Code:               ~1000 lines
Estimated Time to 75% Coverage:   50-60 engineer-hours

================================================================================
                         COVERAGE BY MODULE
================================================================================

Fully Tested (100%):
  config.py              46 statements,   0 missing   [config management]
  content.py             53 statements,   0 missing   [email cleaning]
  database.py            71 statements,   0 missing   [SQLite operations]

Partially Tested (29-72%):
  thunderbird.py        126 statements,  35 missing   [mbox file reading]
  llm.py                246 statements, 153 missing   [LLM integration]
  imap_client.py        167 statements, 118 missing   [IMAP operations]

Not Tested (0%):
  main.py               363 statements, 363 missing   [orchestration]
  mcp_server.py          55 statements,  55 missing   [MCP interface]

================================================================================
                        CRITICAL GAPS IDENTIFIED
================================================================================

PRIORITY 1: MAIN.PY INTEGRATION (0% coverage)
  Severity:   CRITICAL
  Impact:     Core business logic completely untested
  Lines:      363 statements, all missing
  Key paths:
    - EmailProcessor queue management and processing loop (Lines 24-79)
    - Thunderbird three-phase import (Lines 198-314)
    - Batch folder initialization (Lines 387-491)
    - CLI modes and argument handling (Lines 499-663)
  Recommended tests: 25-30 tests covering 50-70 statements
  Effort: 4-5 days for experienced engineer

PRIORITY 2: LLM.PY ERROR HANDLING (38% coverage)
  Severity:   CRITICAL
  Impact:     JSON parsing errors, invalid folder handling untested
  Lines:      153 statements missing, including:
    - JSON response parsing fallbacks (Lines 125-150)
    - Folder structure refinement (Lines 239-352)
    - JSON repair mechanism (Lines 354-371)
    - Category normalization (Lines 373-455)
  Recommended tests: 15-20 tests covering 50-80 statements
  Effort: 3-4 days for experienced engineer

PRIORITY 3: IMAP_CLIENT.PY NETWORK LOGIC (29% coverage)
  Severity:   HIGH
  Impact:     Real IMAP operations untested
  Lines:      118 statements missing
  Key paths:
    - Connection establishment and teardown
    - Folder enumeration
    - Email retrieval and parsing
    - IDLE listener for new emails
  Recommended tests: 12-15 tests covering 40-60 statements
  Effort: 3-4 days for experienced engineer

PRIORITY 4: MCP_SERVER.PY API ENDPOINTS (0% coverage)
  Severity:   MEDIUM
  Impact:     AI-facing API untested
  Lines:      55 statements, all missing
  Recommended tests: 8-10 tests
  Effort: 2-3 days for experienced engineer

================================================================================
                          ONE FAILING TEST
================================================================================

File:    tests/test_config.py
Line:    43
Test:    TestOllamaConfig::test_defaults
Status:  FAILING

Issue:
  assert config.timeout_seconds == 120

But:
  OllamaConfig default timeout_seconds = 300 (from config.py line 23)

Fix:
  Change line 43 to:
  assert config.timeout_seconds == 300

Time to fix: 30 seconds

================================================================================
                          DEPRECATION WARNINGS
================================================================================

Count:   18 warnings
Type:    SQLite datetime adapter deprecation (Python 3.12+)
Files:   database.py (lines 88, 134, 173)
Severity: Low (warnings only, functionality works)
Fix:     Register custom datetime adapters with sqlite3 module
Effort:  1-2 hours to implement and test

================================================================================
                          WHAT'S TESTED WELL
================================================================================

✓ Configuration loading and defaults
✓ Email content cleaning and normalization
✓ Email subject/sender extraction
✓ HTML tag and signature removal
✓ URL and quoted text removal
✓ Text truncation with sentence/word boundaries
✓ Database connection and schema creation
✓ Folder CRUD operations
✓ Email insertion and retrieval
✓ Email classification storage
✓ Classification and confidence updates
✓ Thunderbird profile detection
✓ mbox file reading
✓ Folder hierarchy with subfolders
✓ LLM context manager
✓ Basic JSON response parsing
✓ Malformed JSON fallback handling
✓ Folder description generation

================================================================================
                          WHAT'S NOT TESTED
================================================================================

✗ Email processing queue and loop
✗ LLM response validation (invalid folders, confidence checks)
✗ Thunderbird three-phase import process
✗ Batch folder initialization
✗ CLI argument parsing and modes
✗ Database state management across operations
✗ IMAP connection and folder enumeration
✗ IDLE monitoring for new emails
✗ MCP server endpoint handling
✗ JSON repair mechanism
✗ Category normalization and consolidation
✗ Error recovery in long-running operations
✗ Concurrent email processing
✗ Partial/incomplete LLM responses

================================================================================
                      RECOMMENDED TEST ROADMAP
================================================================================

WEEK 1 - Critical Gaps
  Add: 15 LLM error handling tests
  Target: Lines 125-150, 217-230, 354-371
  Expected coverage gain: 38% → 55%
  Effort: 12-16 hours

WEEK 2 - Integration Tests
  Add: 10 EmailProcessor tests
  Add: 12 IMAP client tests
  Target: main.py lines 24-79, imap_client.py core functions
  Expected coverage gain: 55% → 60%
  Effort: 16-20 hours

WEEK 3 - Complex Workflows
  Add: 8 Thunderbird import tests (three-phase)
  Add: 8 Folder initialization tests
  Target: main.py lines 198-314, 387-491
  Expected coverage gain: 60% → 70%
  Effort: 12-16 hours

WEEK 4 - Polish & MCP
  Add: 10 MCP server tests
  Add: 5-8 thunderbird.py edge cases
  Fix: SQLite deprecation warnings
  Target: mcp_server.py, complete thunderbird.py
  Expected coverage gain: 70% → 75%
  Effort: 10-14 hours

================================================================================
                      TESTING STRATEGY NOTES
================================================================================

Mocking Approach:
  - LLM: Mock httpx.AsyncClient.post() for HTTP responses
  - IMAP: Mock imapclient.IMAPClient for network operations
  - Database: Use temporary SQLite files (already in place)
  - File I/O: Mock filesystem for Thunderbird reader

Test Data:
  - Use realistic email samples with actual headers
  - Include edge cases: HTML emails, forwarded messages, signatures
  - Test both valid and invalid JSON responses from LLM
  - Include network error scenarios

Error Scenarios to Cover:
  - LLM timeouts and connection failures
  - Invalid/malformed JSON responses
  - Missing required JSON fields
  - Invalid folder names
  - Low confidence classifications
  - Database connection failures
  - IMAP connection drops
  - Concurrent email processing
  - File permission errors
  - Corrupted mbox files

================================================================================
                        FILES GENERATED
================================================================================

1. TEST_COVERAGE_ANALYSIS.md
   - Detailed coverage analysis for each module
   - Specific missing test cases with code examples
   - 50+ pages of analysis and recommendations

2. RECOMMENDED_TESTS.md
   - Ready-to-implement test code
   - 40+ complete test functions
   - Copy-paste ready implementations
   - Examples for all 4 priority modules

3. TEST_COVERAGE_QUICK_REFERENCE.md
   - One-page quick reference
   - Coverage summary table
   - Most impactful tests to add
   - Quick commands for running tests

4. TEST_COVERAGE_SUMMARY.txt (this file)
   - Executive summary
   - Key metrics and priorities
   - Quick implementation roadmap

================================================================================
                        HOW TO GET STARTED
================================================================================

Step 1: Fix the failing test (30 seconds)
  $ vi tests/test_config.py
  # Line 43: change 120 to 300
  $ python -m pytest tests/test_config.py -v

Step 2: Review coverage analysis
  $ cat TEST_COVERAGE_ANALYSIS.md

Step 3: Copy recommended test code
  $ cp RECOMMENDED_TESTS.md tests/
  # Implement test_llm_advanced.py first

Step 4: Run tests with coverage
  $ python -m pytest tests/ --cov=mailmap --cov-report=html

Step 5: Iterate on high-value tests
  - Priority: main.py > llm.py > imap_client.py > mcp_server.py

================================================================================
                        KEY STATISTICS
================================================================================

Test count:                     66 tests, 98.5% passing
Code coverage:                  36% (need 39+ more percent for 75% target)
Missing statements:             724 statements need test coverage
Lines of test code to add:      800-1000 lines
Number of new tests needed:     50-65 tests
Estimated implementation time:  50-60 engineer-hours (1.5-2 weeks)
ROI: Medium (good safety net, moderate effort to implement)

Best bang for buck: EmailProcessor (main.py) tests
  - 363 statements to test
  - Critical to application reliability
  - Moderate complexity
  - High impact on bug prevention

================================================================================
                        CONCLUSION
================================================================================

The mailmap project has an excellent foundation with 100% coverage of utility
modules (config, content, database), but critical gaps in orchestration and
integration logic where bugs are most likely to cause production issues.

The recommended approach:
1. Fix the 1 failing test immediately (30 seconds)
2. Add 50-65 high-value tests over 4 weeks
3. Focus on error handling and edge cases first
4. Use the provided test code examples for quick implementation

Target coverage progression:
  Current:     36% (0 weeks)
  After week 1: 55% (12-16 hours)
  After week 2: 60% (28-36 hours)
  After week 3: 70% (40-52 hours)
  After week 4: 75% (50-66 hours)

This represents a solid return on investment in test coverage, reducing
production bugs and improving system reliability.

================================================================================

For detailed analysis, see: TEST_COVERAGE_ANALYSIS.md
For implementation examples, see: RECOMMENDED_TESTS.md
For quick reference, see: TEST_COVERAGE_QUICK_REFERENCE.md

================================================================================
